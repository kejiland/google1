name: Daily Node Filter

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 8:00 æ‰§è¡Œï¼ˆUTC 0:00ï¼‰
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  filter-nodes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: pip install requests
      
    - name: Run filter script
      id: filter-step
      run: |
        echo "å¼€å§‹æ‰§è¡ŒèŠ‚ç‚¹è¿‡æ»¤è„šæœ¬..."
        echo "å½“å‰æ—¶é—´: $(date)"
        
        python filter_nodes.py
        FILTER_EXIT_CODE=$?
        
        echo "Pythonè„šæœ¬é€€å‡ºç : $FILTER_EXIT_CODE"
        
        if [ -f "kejiland.txt" ]; then
          echo "æ–‡ä»¶å·²ç”Ÿæˆ: kejiland.txt"
          echo "file_exists=true" >> $GITHUB_OUTPUT
        else
          echo "æ–‡ä»¶æœªç”Ÿæˆ"
          echo "file_exists=false" >> $GITHUB_OUTPUT
        fi
        
        exit $FILTER_EXIT_CODE
        
    - name: Show result details
      if: steps.filter-step.outputs.file_exists == 'true'
      run: |
        echo "=== è¿‡æ»¤ç»“æœè¯¦æƒ… ==="
        echo ""
        echo "æ–‡ä»¶ä¿¡æ¯:"
        echo "- å¤§å°: $(wc -c < kejiland.txt) å­—èŠ‚"
        echo "- è¡Œæ•°: $(wc -l < kejiland.txt)"
        echo ""
        echo "èŠ‚ç‚¹åè®®ç»Ÿè®¡:"
        echo "ssèŠ‚ç‚¹: $(grep -c -i '^ss[=:]' kejiland.txt 2>/dev/null || echo 0)"
        echo "vmessèŠ‚ç‚¹: $(grep -c -i '^vmess[=:]' kejiland.txt 2>/dev/null || echo 0)"
        echo "vlessèŠ‚ç‚¹: $(grep -c -i '^vless[=:]' kejiland.txt 2>/dev/null || echo 0)"
        echo "trojanèŠ‚ç‚¹: $(grep -c -i '^trojan[=:]' kejiland.txt 2>/dev/null || echo 0)"
        echo ""
        echo "éªŒè¯ç»“æœ:"
        echo "http=èŠ‚ç‚¹: $(grep -c -i '^http=' kejiland.txt 2>/dev/null || echo 0)"
        echo "https=èŠ‚ç‚¹: $(grep -c -i '^https=' kejiland.txt 2>/dev/null || echo 0)"
        echo "socks5=èŠ‚ç‚¹: $(grep -c -i '^socks5=' kejiland.txt 2>/dev/null || echo 0)"
        echo ""
        echo "å‰5è¡Œå†…å®¹:"
        echo "----------------------------------------"
        head -5 kejiland.txt
        echo "----------------------------------------"
        
    - name: Commit changes
      if: steps.filter-step.outputs.file_exists == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        git add kejiland.txt
        
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
        else
          LINES=$(wc -l < kejiland.txt)
          SIZE=$(wc -c < kejiland.txt)
          
          SS_COUNT=$(grep -c -i '^ss[=:]' kejiland.txt 2>/dev/null || echo 0)
          VMESS_COUNT=$(grep -c -i '^vmess[=:]' kejiland.txt 2>/dev/null || echo 0)
          TROJAN_COUNT=$(grep -c -i '^trojan[=:]' kejiland.txt 2>/dev/null || echo 0)
          
          git commit -m "ğŸ”„ æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨ [$(date +'%Y-%m-%d %H:%M')]

ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:
- æ€»èŠ‚ç‚¹æ•°: $LINES
- æ–‡ä»¶å¤§å°: $SIZE å­—èŠ‚
- SSèŠ‚ç‚¹: $SS_COUNT
- VmessèŠ‚ç‚¹: $VMESS_COUNT
- TrojanèŠ‚ç‚¹: $TROJAN_COUNT

ğŸ¤– è‡ªåŠ¨æ›´æ–°"
          
          git push
          echo "âœ… æ›´æ”¹å·²æäº¤"
        fi
        
    - name: View log
      if: always()
      run: |
        if [ -f "filter.log" ]; then
          echo "=== æ‰§è¡Œæ—¥å¿— ==="
          echo "æœ€å10è¡Œæ—¥å¿—:"
          echo "----------------------------------------"
          tail -10 filter.log
          echo "----------------------------------------"
        else
          echo "æ²¡æœ‰æ—¥å¿—æ–‡ä»¶"
        fi

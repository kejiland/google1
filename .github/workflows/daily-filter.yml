name: Daily Node Filter

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 8:00 æ‰§è¡Œï¼ˆUTC 0:00ï¼‰
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  filter-nodes:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install requests
        
    - name: ğŸš€ æ‰§è¡Œè¿‡æ»¤è„šæœ¬
      id: filter
      run: |
        echo "=== å¼€å§‹æ‰§è¡ŒèŠ‚ç‚¹è¿‡æ»¤ ==="
        echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        # æ‰§è¡Œ Python è„šæœ¬
        python filter_nodes.py
        FILTER_EXIT_CODE=$?
        
        echo ""
        echo "è¿‡æ»¤è„šæœ¬é€€å‡ºç : $FILTER_EXIT_CODE"
        
        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        if [ -f "kejiland.txt" ]; then
          echo "kejiland.txt å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "âœ… kejiland.txt å·²ç”Ÿæˆ"
          echo "file_generated=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ kejiland.txt æœªç”Ÿæˆ"
          echo "file_generated=false" >> $GITHUB_OUTPUT
        fi
        
        exit $FILTER_EXIT_CODE
        
    - name: ğŸ“Š æ˜¾ç¤ºè¿‡æ»¤ç»“æœè¯¦æƒ…
      if: steps.filter.outputs.file_generated == 'true'
      run: |
        echo "=== è¿‡æ»¤ç»“æœè¯¦æƒ… ==="
        
        # æ˜¾ç¤ºæ–‡ä»¶åŸºæœ¬ä¿¡æ¯
        echo "ğŸ“ æ–‡ä»¶ä¿¡æ¯:"
        echo "- å¤§å°: $(wc -c < kejiland.txt) å­—èŠ‚"
        echo "- è¡Œæ•°: $(wc -l < kejiland.txt)"
        
        echo ""
        echo "ğŸ“‹ å†…å®¹é¢„è§ˆ:"
        echo "----------------------------------------"
        
        # æ˜¾ç¤ºå„ç§åè®®çš„èŠ‚ç‚¹æ•°é‡
        echo "ğŸ” èŠ‚ç‚¹åè®®ç»Ÿè®¡:"
        echo "ss èŠ‚ç‚¹: $(grep -c -i '^ss[=:]' kejiland.txt 2>/dev/null || echo 0)"
        echo "vmess èŠ‚ç‚¹: $(grep -c -i '^vmess[=:]' kejiland.txt 2>/dev/null || echo 0)"
        echo "vless èŠ‚ç‚¹: $(grep -c -i '^vless[=:]' kejiland.txt 2>/dev/null || echo 0)"
        echo "trojan èŠ‚ç‚¹: $(grep -c -i '^trojan[=:]' kejiland.txt 2>/dev/null || echo 0)"
        
        echo ""
        echo "âœ… éªŒè¯æ—  HTTP/SOCKS5:"
        echo "http=: $(grep -c -i '^http=' kejiland.txt 2>/dev/null || echo 0)"
        echo "https=: $(grep -c -i '^https=' kejiland.txt 2>/dev/null || echo 0)"
        echo "socks5=: $(grep -c -i '^socks5=' kejiland.txt 2>/dev/null || echo 0)"
        
        echo ""
        echo "ğŸ“ å‰5è¡Œå†…å®¹:"
        head -5 kejiland.txt
        echo "----------------------------------------"
        
    - name: ğŸ“ æäº¤æ›´æ”¹
      if: steps.filter.outputs.file_generated == 'true'
      run: |
        # é…ç½® Git ç”¨æˆ·
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # æ·»åŠ è¦æäº¤çš„æ–‡ä»¶
        git add kejiland.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --cached --quiet; then
          echo "ğŸ“Œ kejiland.txt æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          echo "ğŸ“¤ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
          
          # è·å–æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
          LINE_COUNT=$(wc -l < kejiland.txt)
          FILE_SIZE=$(wc -c < kejiland.txt)
          
          # è·å–èŠ‚ç‚¹ç±»å‹ç»Ÿè®¡
          SS_COUNT=$(grep -c -i '^ss[=:]' kejiland.txt 2>/dev/null || echo 0)
          VMESS_COUNT=$(grep -c -i '^vmess[=:]' kejiland.txt 2>/dev/null || echo 0)
          TROJAN_COUNT=$(grep -c -i '^trojan[=:]' kejiland.txt 2>/dev/null || echo 0)
          
          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ”„ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨ [$(date +'%Y-%m-%d %H:%M')]

ğŸ“Š èŠ‚ç‚¹ç»Ÿè®¡:
- æ€»èŠ‚ç‚¹æ•°: ${LINE_COUNT}
- æ–‡ä»¶å¤§å°: ${FILE_SIZE} å­—èŠ‚

ğŸ¯ èŠ‚ç‚¹ç±»å‹:
- SS: ${SS_COUNT}
- Vmess: ${VMESS_COUNT}
- Trojan: ${TROJAN_COUNT}

ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)"

          # æäº¤å¹¶æ¨é€
          git commit -m "${COMMIT_MSG}"
          git push
          
          echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
        fi
        
    - name: ğŸ“‹ æŸ¥çœ‹æ—¥å¿—
      if: always()
      run: |
        echo "=== æ‰§è¡Œæ—¥å¿— ==="
        if [ -f "filter.log" ]; then
          echo "ğŸ“„ filter.log æœ€å20è¡Œ:"
          echo "----------------------------------------"
          tail -20 filter.log
          echo "----------------------------------------"
          
          # æ·»åŠ æ—¥å¿—æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          git add filter.log 2>/dev/null || true
        else
          echo "ğŸ“ æ— æ—¥å¿—æ–‡ä»¶"
        fi
